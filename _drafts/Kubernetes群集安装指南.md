# Kubernetes 集群安装指南

## 环境

- 操作系统：Centos7
- master 
    - 内网：192.168.0.8
    - 外网：DHCP 
- worker1:
    - 内网：192.168.0.9
    - 外网：DHCP
- DNS服务器：192.168.0.1

## 安装Centos 7

安装过程忽略，请自行查找教程。

### 设置国内镜像

安装完Centos 7后要设置国内镜像源加速，否则`yum`安装速度很慢。以下是使用阿里云镜像服务设置方法。`yum makecache`这一步如果服务器非阿里云ECS会出现 `Couldn't resolve host 'mirrors.cloud.aliyuncs.com'` 信息，不影响使用。

```sh
# 备份
sudo mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup

# 使用curl下载阿里云镜像仓库配置

curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo

# 生成缓存
yum makecache
```

### 设置IP地址

虚拟机添加了`eth0`、`eth1`两个网口，`eth0`为`192.168.0.1/24`网段，作为虚拟机之间通讯的内网，`eth1`配置动态IP作为外网网口。

**配置eth0的静态IP**

Centos最小化安装只有`vi`没有`vim`

```sh
sudo vi /etc/sysconfig/network-scripts/ifcfg-eth0
```

修改配置文件设置网卡`eth0`为`192.168.0.8`的静态IP。

**注意:** GATEWAY不能填写，否则不能上外网。

```ini
BOOTPROTO=static        # 默认dhcp,改为static,表示启用静态IP地址
IPADDR=192.168.0.8      # 静态IP地址
NETMASK=255.255.255.0   # 子网掩码，需和公网主机配置的网关一致
# GATEWAY=192.168.1.254 # 不能设网关地址
DNS1=192.168.0.1        # 第一个dns服务器，这个地址是内网的DNS服务器，根据你的情况填写
PEERDNS=yes             # 修改/etc/resolv.conf中的DNS配置
ONBOOT=yes              # 开启自动启用网络连接
```

**配置eth1的动态IP**

```sh
sudo vi /etc/sysconfig/network-scripts/ifcfg-eth1
```

动态IP配置比较简单，设为开机启用即可，其它内容都不变。

```ini
ONBOOT=yes #开启自动启用网络连接
PEERDNS=no #不修改/etc/resolv.conf中的DNS配置，我们使用内网DNS做解析，确保内外网的域名都正常访问。
```

配置好以后保存退出，`service network restart`重启网络之后生效.

最后检查一下`/etc/resolv.conf`文件中的DNS配置，应该只有一条内网DNS服务地址，不然就删掉其它的。
```conf
cat /etc/resolv.conf 

# Generated by NetworkManager
nameserver 192.168.0.1
```

### 更新系统

```sh
yum update
```

## 检查系统信息

查看操作系统的version、hostname、cpu信息，后面很多地方需要用到`hostname`，提前了解做到心中有数。如果名称不方便记忆可以自行修改。

```sh
# 查看操作系统版本。在 master 节点和 worker 节点都要执行
cat /etc/redhat-release
# 我的输出是：CentOS Linux release 7.7.1908 (Core)

# 此处 hostname 的输出将会是该机器在 Kubernetes 集群中的节点名字
# 不能使用 localhost 作为节点的名字
hostname

# 请使用 lscpu 命令，核对 CPU 信息
# Architecture: x86_64    本安装文档不支持 arm 架构
# CPU(s):       2         CPU 内核数量不能低于 2
lscpu
```

**修改`hostname`**

```sh
# 修改 hostname, 把"your-new-host-name"改成你喜欢的名字
sudo hostnamectl set-hostname your-new-host-name
# 查看修改结果
hostnamectl status

```

## 检查网络

```
$ ip route show
default via 10.87.10.1 dev eth0 proto dhcp metric 100 
10.87.10.0/24 dev eth0 proto kernel scope link src 10.87.10.138 metric 100 
192.168.122.0/24 dev virbr0 proto kernel scope link src 192.168.122.1 

$ ip address
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether 00:15:5d:00:c9:0b brd ff:ff:ff:ff:ff:ff
    inet 10.87.10.138/24 brd 10.87.10.255 scope global 
    
    ...
```

**kubelet使用的IP地址**

`ip route show` 命令中，可以知道机器的默认网卡，通常是 `eth0`，如 `default via 10.87.10.1 dev eth0`

`ip address` 命令中，可显示默认网卡的 IP 地址，Kubernetes 将使用此 IP 地址与集群内的其他节点通信，如 `10.87.10.138`
所有节点上 Kubernetes 所使用的 IP 地址必须可以互通（无需 NAT 映射、无安全组或防火墙隔离）

## 安装Master

### 安装Docker和kubernetes

本文是安装Docker版本是`19.03.5`，可以在这里[查看最新Docker版本号](https://docs.docker.com/engine/release-notes/)

将以下内容保存为`install.sh`。

```sh
#!/bin/bash

# 在 master 节点和 worker 节点都要执行

# 安装 docker
# 参考文档如下
# https://docs.docker.com/install/linux/docker-ce/centos/ 
# https://docs.docker.com/install/linux/linux-postinstall/

# 卸载旧版本
yum remove -y docker \
docker-client \
docker-client-latest \
docker-common \
docker-latest \
docker-latest-logrotate \
docker-logrotate \
docker-selinux \
docker-engine-selinux \
docker-engine

# 设置 yum repository
yum install -y yum-utils \
device-mapper-persistent-data \
lvm2
yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo

# 安装并启动 docker
yum install -y docker-ce-19.03.5 docker-ce-cli-19.03.5 containerd.io
systemctl enable docker
systemctl start docker

# 安装 nfs-utils
# 必须先安装 nfs-utils 才能挂载 nfs 网络存储
yum install -y nfs-utils
yum install -y wget

# 关闭 防火墙
systemctl stop firewalld
systemctl disable firewalld

# 关闭 SeLinux
setenforce 0
sed -i "s/SELINUX=enforcing/SELINUX=disabled/g" /etc/selinux/config

# 关闭 swap
swapoff -a
yes | cp /etc/fstab /etc/fstab_bak
cat /etc/fstab_bak |grep -v swap > /etc/fstab

# 修改 /etc/sysctl.conf
# 如果有配置，则修改
sed -i "s#^net.ipv4.ip_forward.*#net.ipv4.ip_forward=1#g"  /etc/sysctl.conf
sed -i "s#^net.bridge.bridge-nf-call-ip6tables.*#net.bridge.bridge-nf-call-ip6tables=1#g"  /etc/sysctl.conf
sed -i "s#^net.bridge.bridge-nf-call-iptables.*#net.bridge.bridge-nf-call-iptables=1#g"  /etc/sysctl.conf
# 可能没有，追加
echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.conf
echo "net.bridge.bridge-nf-call-ip6tables = 1" >> /etc/sysctl.conf
echo "net.bridge.bridge-nf-call-iptables = 1" >> /etc/sysctl.conf
# 执行命令以应用
sysctl -p

# 配置K8S的yum源
cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
       http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF

# 卸载旧版本
yum remove -y kubelet kubeadm kubectl

# 安装kubelet、kubeadm、kubectl
yum install -y kubelet-${1} kubeadm-${1} kubectl-${1}

# 修改docker Cgroup Driver为systemd
# # 将/usr/lib/systemd/system/docker.service文件中的这一行 ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
# # 修改为 ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd
# 如果不修改，在添加 worker 节点时可能会碰到如下错误
# [WARNING IsDockerSystemdCheck]: detected "cgroupfs" as the Docker cgroup driver. The recommended driver is "systemd". 
# Please follow the guide at https://kubernetes.io/docs/setup/cri/
sed -i "s#^ExecStart=/usr/bin/dockerd.*#ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd#g" /usr/lib/systemd/system/docker.service

# 设置 docker 镜像，提高 docker 镜像下载速度和稳定性
# 如果您访问 https://hub.docker.io 速度非常稳定，亦可以跳过这个步骤
curl -sSL https://get.daocloud.io/daotools/set_mirror.sh | sh -s http://f1361db2.m.daocloud.io

# 重启 docker，并启动 kubelet
systemctl daemon-reload
systemctl restart docker
systemctl enable kubelet && systemctl start kubelet

docker version
```

运行安装的脚本，后面的参数是`kubernetes`的版本号，根据需要修改。

```sh
sudo sh ./install.sh 1.17.1
```

### 初始化Master节点

只在 master 节点执行。

以下内容保存为`init_master.sh`

```sh
#!/bin/bash

# 只在 master 节点执行

# 脚本出错时终止执行
set -e

if [ ${#POD_SUBNET} -eq 0 ] || [ ${#APISERVER_NAME} -eq 0 ]; then
  echo -e "\033[31;1m请确保您已经设置了环境变量 POD_SUBNET 和 APISERVER_NAME \033[0m"
  echo 当前POD_SUBNET=$POD_SUBNET
  echo 当前APISERVER_NAME=$APISERVER_NAME
  exit 1
fi


# 查看完整配置选项 https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2
rm -f ./kubeadm-config.yaml
cat <<EOF > ./kubeadm-config.yaml
apiVersion: kubeadm.k8s.io/v1beta2
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: "${MASTER_IP}"
  bindPort: 6443

---

apiVersion: kubeadm.k8s.io/v1beta2
kind: ClusterConfiguration
kubernetesVersion: v${1}
imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers
controlPlaneEndpoint: "${APISERVER_NAME}:6443"
networking:
  serviceSubnet: "10.96.0.0/16"
  podSubnet: "${POD_SUBNET}"
  dnsDomain: "cluster.local"
EOF

# kubeadm init
# 根据您服务器网速的情况，您需要等候 3 - 10 分钟
kubeadm init --config=kubeadm-config.yaml --upload-certs

# 配置 kubectl
rm -rf /root/.kube/
mkdir /root/.kube/
cp -i /etc/kubernetes/admin.conf /root/.kube/config

# 安装 calico 网络插件
# 参考文档 https://docs.projectcalico.org/v3.10/getting-started/kubernetes/
echo "安装calico-3.10.2"
rm -f calico-3.10.2.yaml
wget https://kuboard.cn/install-script/calico/calico-3.10.2.yaml
sed -i "s#192\.168\.0\.0/16#${POD_SUBNET}#" calico-3.10.2.yaml
kubectl apply -f calico-3.10.2.yaml

```

设置好基本参数后运行`init_master.sh`脚本，后面的参数是kubernates的版本号，根据需要修改。

**注意：** 这段代码请`su`切换到`root`账户下执行。

```sh
# 替换 x.x.x.x 为 master 节点的内网IP
# export 命令只在当前 shell 会话中有效，开启新的 shell 窗口后，如果要继续安装过程，请重新执行此处的 export 命令
export MASTER_IP=192.168.0.8
#  apiserver.k8s.cd.xunmei.com 已经在dns服务解析到 192.168.0.8
export APISERVER_NAME=apiserver.k8s.cd.xunmei.com
# Kubernetes 容器组所在的网段，该网段安装完成后，由 kubernetes 创建，事先并不存在于您的物理网络中
export POD_SUBNET=10.11.0.1/16

sh ./init_master.sh 1.17.1
```

### 检查 master 初始化结果

等待初始化完成，这步耗时比较长耐心等待，我等了接近20分钟。

```sh
# 只在 master 节点执行

# 执行如下命令，等待 5-30 分钟，直到所有的容器组处于 Running 状态
watch kubectl get pod -n kube-system -o wide

# 查看 master 节点初始化结果
kubectl get nodes -o wide
```

## 安装Worker

### 安装Docker和kubernetes

步骤同Master

### 获得 join命令参数

**在 master 节点上执行**

```sh
# 在 master 节点执行
kubeadm token create --print-join-command

# 输出
kubeadm join apiserver.k8s.cd.xunmei.com:6443 --token 4omw92.tj5dyqd200mwl6dq     --discovery-token-ca-cert-hash sha256:92cc6a91a0d9bfbdd6b2e8487233b9fda3505ce228267158e487a5b0d6682bd7 
```

**有效时间**

    该 token 的有效时间为 2 个小时，2小时内，您可以使用此 token 初始化任意数量的 worker 节点。


### 初始化worker

如果有多个worker节点每个都要执行。

**注意：** 这段代码请`su`切换到`root`账户下执行。

```sh
# 只在 worker 节点执行
# 替换 192.168.0.8 为 master 节点的内网 IP
export MASTER_IP=192.168.0.8

# 替换 192.168.0.9 为当前 worker 节点的内网 IP
export WORKER_IP=192.168.0.9
# 替换 apiserver.demo 为初始化 master 节点时所使用的 APISERVER_NAME
export APISERVER_NAME=apiserver.k8s.cd.xunmei.com
echo "${MASTER_IP}    ${APISERVER_NAME}" >> /etc/hosts

# 替换为 master 节点上 kubeadm token create 命令的输出
kubeadm join apiserver.k8s.cd.xunmei.com --apiserver-advertise-address=${WORKDER_IP} --token mpfjma.4vjjg8flqihor4vt     --discovery-token-ca-cert-hash sha256:6f7a8e40a810323672de5eee6f4d19aa2dbdb38411845a1bf5dd63485c43d303
```

### 检查初始化结果

```sh
# 只在 master 节点执行
kubectl get nodes -o wide

# 输出结果如下所示：

$ sudo kubectl get nodes -o wide
NAME          STATUS   ROLES    AGE     VERSION   INTERNAL-IP    EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION               CONTAINER-RUNTIME
k8s-master    Ready    master   148m    v1.17.1   10.87.10.140   <none>        CentOS Linux 7 (Core)   3.10.0-1062.9.1.el7.x86_64   docker://18.9.7
k8s-worker1   Ready    <none>   4m28s   v1.17.1   192.168.0.9    <none>        CentOS Linux 7 (Core)   3.10.0-1062.9.1.el7.x86_64   docker://18.9.7
```

## 安装 Ingress Controller

```sh
# 只在 master 节点执行
sudo kubectl apply -f https://kuboard.cn/install-script/v1.17.x/nginx-ingress.yaml
 
```

## 安装 Kuboard

```sh
kubectl apply -f https://kuboard.cn/install-script/kuboard.yaml
kubectl apply -f https://addons.kuboard.cn/metrics-server/0.3.6/metrics-server.yaml
```

查看 Kuboard 运行状态

```
kubectl get pods -l k8s.eip.work/name=kuboard -n kube-system
```



## 常用操作

### 防火墙

```sh
# firewall防火墙
# 1、查看firewall服务状态
systemctl status firewalld

# 2、查看firewall的状态
firewall-cmd --state

# 3、开启、重启、关闭、firewalld.service服务

# 开启
service firewalld start
# 重启
service firewalld restart
# 关闭
service firewalld stop

#4、查看防火墙规则
firewall-cmd --list-all 

#5、查询、开放、关闭端口

# 查询端口是否开放
firewall-cmd --query-port=8080/tcp
# 开放80端口
firewall-cmd --permanent --add-port=80/tcp
# 移除端口
firewall-cmd --permanent --remove-port=8080/tcp
 
#重启防火墙(修改配置后要重启防火墙)
firewall-cmd --reload
# 参数解释
# 1、firwall-cmd：是Linux提供的操作firewall的一个工具；
# 2、--permanent：表示设置为持久；
# 3、--add-port：标识添加的端口；
```

### 网卡启用禁用

服务器内网和外网网卡都配置了DNS服务器，导致不能同时使用。下面是快速启用禁用网卡操作。

```sh
# ifup {interface}     //启动网卡命令
# ifdown {interface}   //禁用网卡命令

# 启动网卡eth0
sudo ifup eth0　　

# 禁用网卡eth0
sudo ifdown eth0
```



## 参考

- [CentOS 7 双网卡双IP双网关配置](https://www.linuxidc.com/Linux/2018-05/152427.htm)
- [CentOS 7 网络设置及静态IP配置](https://my.oschina.net/calmsnow/blog/3002952)
- [使用kubeadm安装kubernetes_v1.17.x](
https://www.kuboard.cn/install/install-k8s.html#%E6%96%87%E6%A1%A3%E7%89%B9%E7%82%B9)
- [kubeadm init 问题和解决问题记录](https://blog.csdn.net/myembedded/article/details/88703629)
- [Centos中iptables和firewall防火墙开启、关闭、查看状态、基本设置等](https://blog.csdn.net/bbwangj/article/details/74502967)